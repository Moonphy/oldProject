<?php TPL::output('global/gaofen_new/header.tpl.htm'); ?>
<div class="container pb30">
    <ul class="ui-crumbs clearfix">
        <!-- <li><a href="<?php echo base_url(); ?>" title="">主页</a></li> -->
        <!-- <li>&gt;</li>
        <li><a href="column/" title="" class="font-blue-dark">栏目</a></li> -->
    </ul>
    <div class="row clearfix">
        <div class="span820 fl">
            <div class="ui-article">
                <div class="article-title">
                    <h2><?php echo $this->article_info['title']; ?></h2>
                    <div class="pt10 pb10"><span class="font-nm mr20"><i class="icon icon-person"></i><i><?php echo $this->article_info['user_info']['user_name']; ?></i></span><span class="font-nm"><i class="icon icon-time"></i><i><?php echo date('Y-m-d',$this->article_info['add_time']) ?></i></span>
                        <?php if($this->user_id){ ?>
                        <div class="fr">
                            <a href="javascript: void(0);" class="ui-label label-red btn-fav"><i class="icon icon-fav"></i>收藏</a>
                            <a href="javascript:;" class="ui-label label-blue" id="to_comment">评论<span><?php echo $this->article_info['comments']; ?></span></a>
                            <a href="javascript: void(0);" class="ui-label label-orange" id="btn-article-zan">点赞<span><?php echo $this->article_info['votes']; ?></span></a>
                        </div>
                        <?php } ?>
                    </div>
                </div>
                <!-- 文章内容 -->
                <div class="article-content mt20">
                    
                    <?php echo $this->article_info['message']; ?>

                    <?php if ($this->article_info['attachs']) {  ?>
                    <div class="aw-upload-img-list">
                    <?php foreach ($this->article_info['attachs'] AS $attach) { ?>
                    <?php if ($attach['is_image'] AND (!$this->article_info['attachs_ids'] OR !in_array($attach['id'], $this->article_info['attachs_ids']))) { ?>
                        <a href="<?php echo $attach['attachment']; ?>" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="<?php echo $attach['attachment']; ?>" class="img-polaroid" alt="<?php echo $attach['file_name']; ?>" /></a>
                    <?php } ?>
                    <?php } ?>
                    </div>
                    <?php } ?>

                    <?php if ($this->article_info['attachs']) {  ?>
                    <ul class="aw-upload-file-list">
                        <?php foreach ($this->article_info['attachs'] AS $attach) { ?>
                        <?php if (!$attach['is_image'] AND (!$this->article_info['attachs_ids'] OR !in_array($attach['id'], $this->article_info['attachs_ids']))) { ?>
                            <li><a href="<?php echo download_url($attach['file_name'], $attach['attachment']); ?>"><i class="icon icon-attach"></i> <?php echo $attach['file_name']; ?></a></li>
                        <?php } ?>
                        <?php } ?>
                    </ul>
                    <?php } ?>
                </div>
                <div class="article-bottom" style="margin-top:20px;">
                    <?php foreach ($this->fav_tags_list as $key => $value) { ?>
                        <a href="#" title="<?php echo $value ?>" class="article-label"><?php echo $value ?></a>
                    <?php } ?>
                    <!-- 分享到朋友圈微信等-->
                    <div class="ui-share fr">
                        <span class="fl font-md pt5">分享：</span>
                        <ul class="fl">
                            <li class="fl"><a href="javascript:;" class="btn-weibo" onclick="JZ.share_out({webid:'tsina',content: $(this).parents('.ui-article').find('.article-content')})"><i class="icon icon-weibo"></i></a></li>
                            <li class="fl"><a href="javascript:;" class="btn-qq" onclick="JZ.share_out({webid:'qzone',content: $(this).parents('.ui-article')})"><i class="icon icon-qq"></i></a></li>
                            <li class="fl"><a href="javascript:;" class="btn-wechat" onclick="JZ.share_out({webid:'weixin',content: $(this).parents('.ui-article')})"><i class="icon icon-wechat"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- 评论区--登录状态-->
            <div id="comment" class="ui-comment">

                <?php if ($this->article_info['lock']) { ?>
                <p align="center"><?php _e('该文章目前已经被锁定, 无法添加新评论'); ?></p>
                <?php } else if (!$this->user_id) { ?>
                    <!-- 评论区--未登录状态-->
                    <div id="comment" class="ui-comment mb40">
                        <div class="comment-header"><span class="comment-header-title">文章评论</span></div>
                        <div class="mt15 mb10">
                            <div class="avatar-container">
                                <div class="ui-avatar"><img src="<?php echo G_STATIC_URL; ?>/img/gaofen_new/avatar-mid-img.png" alt="默认未登录头像"></div>
                            </div><a href="login/" title="" class="avatar-user font-red ml5">登录</a><span class="ml5 font-nm">后参与讨论</span>
                        </div>
                        <div class="comment-form clearfix">
                            <form>
                                <textarea placeholder="参与讨论前请先登录" disabled="disabled" class="disabled"></textarea>
                            </form>
                        </div>
                        
                    </div>
                <?php } else { ?>
                    <div class="comment-header"><span class="comment-header-title">文章评论<span class="font-md font-grey">(<?php echo $this->comments_count ?>)</span></span>
                    </div>
                    <div class="mt15 mb10">
                        <div class="avatar-container">
                            <div class="ui-avatar"><img src="<?php echo get_avatar_url($this->user_info['uid'], 'mid'); ?>"></div><i class="avatar-lev hidden">Lv.48</i>
                        </div><span class="avatar-user ml5"><?php echo $this->user_info['user_name']; ?></span>
                    </div>
                    <div class="comment-form clearfix">
                        <form id="article-comment-form">
                            <input type="hidden" name="post_hash" value="<?php echo new_post_hash(); ?>" />
                            <textarea></textarea><a href="javascript: void(0);" class="btn btn-blue btn-sm fr mt10" id="btn-article-comment">评论</a>
                        </form>
                    </div>
                <?php } ?>
                
                <?php if($this->comments_count == 0){ ?>
                <!-- 没有评论时-->
                <div class="comment-none mt50 mb30"><span class="font-blue-dark">暂无评论</span></div>
                <?php }else{ ?>
                <!-- 评论区 -->
                <div class="comment-container">
                    <ul class="comment-list">
                        <?php foreach ($this->comments as $key => $value) { ?>
                            <?php if($value['at_user_info']){ ?>
                                <li class="comment-item">
                                    <div class="avatar-container fl">
                                        <div class="ui-avatar">
                                            <img src="<?php echo $value['avatar_url'] ?>">
                                        </div><i class="avatar-lev hidden">Lv.26</i>
                                    </div>
                                    <div class="comment-item-content" data-id="<?php echo $value['uid'] ?>">
                                        <div class="item-header">
                                            <span class="avatar-user mr10"><?php echo $value['user_info']['user_name'] ?></span>
                                            <span class="font-md font-blue mr10">回复</span>
                                            <span class="avatar-user mr10"><?php echo $value['at_user_info']['user_name'] ?></span>
                                            <span><?php echo date('Y-m-d',$value['add_time']) ?></span>
                                        </div>
                                        <div class="item-content">
                                            <p><?php echo $value['message'] ?></p>
                                        </div>
                                        <?php if ($this->user_id) { ?>
                                        <div class="item-reply">
                                            <a href="javascript: void(0);" title="" class="btn-zan" data-item-id="<?php echo $value['article_id'] ?>"><i class="icon icon-zan"></i><span>0</span></a>
                                            <a href="javascript: void(0);" title="" class="btn-comment"><i class="icon icon-msg-grey"></i></a>
                                        </div>
                                        <?php } ?>
                                    </div>
                                </li>
                            <?php }else{ ?>
                                <li class="comment-item">
                                    <div class="avatar-container fl">
                                        <div class="ui-avatar"><img src="<?php echo $value['avatar_url'] ?>"></div><i class="avatar-lev hidden">Lv.26</i>
                                    </div>
                                    <div class="comment-item-content" data-id="<?php echo $value['uid'] ?>">
                                        <div class="item-header"><span class="avatar-user mr10"><?php echo $value['user_info']['user_name'] ?></span><span><?php echo date('Y-m-d',$value['add_time']) ?></span></div>
                                        <div class="item-content">
                                            <p><?php echo $value['message'] ?></p>
                                        </div>
                                        <?php if ($this->user_id) { ?>
                                        <div class="item-reply"><a href="javascript: void(0);" title="" class="btn-zan" data-item-id="<?php echo $value['article_id'] ?>"><i class="icon icon-zan"></i><span>0</span></a><a href="javascript: void(0);" title="" class="btn-comment"><i class="icon icon-msg-grey"></i></a></div>
                                        <?php } ?>
                                    </div>
                                </li>
                            <?php } ?>
                        <?php } ?>
                    </ul>
                    <div class="loader-box-f" style="display: none;"><span></span><span></span><span></span><span></span><span></span></div>
                </div>
                <?php } ?>
            </div>
            
        </div>
        <div class="span260 fr">
            <div class="right-thumbnail article-thumbnail">
                <div class="img-wrap"><img src="<?php echo G_STATIC_URL; ?>/img/gaofen_new/title-p-a.png" alt=""></div>
                <ul class="thumbnail-list">
                    <?php foreach ($this->question_related_list as $key => $value) { ?>
                        <li class="thumbnail-item"><a href="article/<?php echo $value['id'] ?>" title="" target="_blank" class="clearfix">
                                <div class="thumbnail-item-img fl"><img src="<?php echo $value['article_cover_url_big'] ?>"></div>
                                <div class="thumbnail-item-title"><?php echo $value['title'] ?></div></a>
                        </li>
                    <?php } ?>
                </ul>
            </div>
            <div class="right-thumbnail question-thumbnail">
                <div class="img-wrap"><img src="<?php echo G_STATIC_URL; ?>/img/gaofen_new/title-p-q.png" alt=""></div>
                <ul class="thumbnail-list">
                    <?php foreach ($this->question_list_hot as $key => $value) { ?>
                        <li class="thumbnail-item"><a href="question/<?php echo $value['question_id'] ?>" title="" target="_blank"><?php echo $value['question_content'] ?></a></li>
                    <?php } ?>
                </ul>
            </div>
        </div>
    </div>
    <div class="ui-dialog aw-favorite-box">
        <div class="dialog-wrap">
            <div class="dialog-header">收藏</div>
            <div class="dialog-content">
                <form id="favorite_form">
                    <input type="hidden" name="item_id" value="<?php echo $_GET['id']?>">
                    <input type="hidden" name="item_type" value="article">
                    <input id="add_favorite_tags" type="text" name="tags" value="" class="hidden">
                    <div class="aw-favorite-tag-list">
                        <div class="favorite-tag-list-content">
                            <ul></ul>
                        </div>
                        <div class="dialog-footer">
                            <a href="javascript:;" onclick="$('.aw-favorite-box .aw-favorite-tag-list').hide();$('.aw-favorite-box .aw-favorite-tag-add').show();" class="btn btn-blue btn-sm">创建标签</a>
                            <a href="javascript:;" class="btn disabled btn-sm" id="btn-close">关闭</a>
                        </div>
                    </div>
                    <div class="aw-favorite-tag-add">
                        <div class="favorite-tag-add-content">
                            <input type="text" name="tags" value="" placeholder="标签名字" class="add-input">
                        </div>
                        <div class="dialog-footer">
                            <a href="javascript:;" onclick="$('.aw-favorite-box .aw-favorite-tag-list').show();$('.aw-favorite-box .aw-favorite-tag-add').hide();" class="btn disabled btn-sm">取消</a>
                            <a href="javascript:;" onclick="JZ.add_favorite_tag()" class="btn btn-blue btn-sm">确认创建</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="<?php echo G_STATIC_URL; ?>/js/gaofen_new/jquery.1.8.2.js"></script>
<script src="<?php echo G_STATIC_URL; ?>/js/gaofen_new/swipePC.js"></script>
<script src="<?php echo G_STATIC_URL; ?>/js/gaofen_new/common.js"></script>
<script src="<?php echo G_STATIC_URL; ?>/js/plugins/global/bbcode.js"></script>
<!--<script src="<?php echo G_STATIC_URL; ?>/js/gaofen_new/layer/layer.js"></script>-->
<script>
    var _url = window.location.href;
    var _hash = window.location.hash;
    var comment_page = 2;
    var _get = 0;

    $('.wrap').removeClass('index-page');
    // 插入回复评论输入框
    $('.ui-comment').on('click', '.btn-comment', function () {
        var commentDOM = JZ_TEMPLATE.comment_form;

        $('.add-comment-form').slideUp().remove();
        $(this).parent().after(commentDOM);
        $('.add-comment-area').focus();
    });
    // 点赞
    $('#btn-article-zan').click(function () {
        if(!$(this).hasClass('active')){
            $(this).addClass('active');

            var item_url = _url.split('/');
            var item_id = item_url[item_url.length - 1].split('#')[0];

            // 添加ajax
            JZ.article_comment_vote($(this),item_id,1,'article')
        }
    });
    $('.ui-comment').on('click', '.btn-zan', function () {
        if(!$(this).hasClass('active')){
            $(this).addClass('active');

            var item_id = $(this).attr('data-item-id');

            // 添加ajax
            JZ.article_comment_vote($(this),item_id,1, 'comment')
        }
    });
    // 评论文章
    $('#btn-article-comment').click(function () {
        var item_url = _url.split('/');
        var article_id = item_url[item_url.length - 1].split('#')[0];
        var message = $(this).parent().find('textarea').val();
        var post_hash = $(this).parent().find('input[name="post_hash"]').val();
        // 添加ajax
        JZ.save_article_comment($(this), article_id, message, post_hash);
    });
    // 回复评论
    $('.ui-comment').on('click', '.btn-reply', function () {
        var item_url = _url.split('/');
        var article_id = item_url[item_url.length - 1].split('#')[0];
        var message = $(this).parent().find('textarea').val();
        var post_hash = $('#article-comment-form').find('input[name="post_hash"]').val();
        var at_uid = $(this).parent().parent().parent().attr('data-id');

        JZ.save_comment($(this), article_id, message, post_hash, at_uid);
    });
    $('#to_comment').click(function () {
        if(!_hash){
            $(this).attr('href',_url + '#comment')
        }else{
            $(this).attr('href',_url)
        }
    });

    $(window).scroll(function () {
        var scrollTop = $(this).scrollTop();
        var winHeight = $(this).height();
        var docHeight = $(document).height();
        var BASE_URL;

        if ( scrollTop + winHeight > docHeight - 200) {
            if(!_get) {
                _get = 1;

                if(!_hash){
                    BASE_URL = _url + '?page=' + comment_page;
                }else{
                    var _url_ = _url.split('#')[0];
                    BASE_URL = _url_ + '?page=' + comment_page;
                }
                JZ.load_comment_list(BASE_URL)
            }
        }
    });
    $('.btn-fav').click(function () {
        var liLength = $('.favorite-tag-list-content ul li').length;
        if(!liLength){
            JZ.get_favorite_tag();
        }
        $('.ui-dialog').show();
    });
    $('#btn-close').on('click', function () {
        // 这里需ajax
        $('.ui-dialog').hide();
        return false;
    })


</script>
<?php TPL::output('global/gaofen_new/footer.tpl.htm'); ?>