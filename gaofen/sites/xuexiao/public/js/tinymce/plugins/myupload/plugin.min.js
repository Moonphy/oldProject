tinymce.PluginManager.add('myupload', function(editor, url) {
	
	var inited = false;

	function upload() {
		//if(!inited) init();
		//inited = true;
		// console.log(editor.selection.getContent())
		var tb = editor.windowManager.open({
			title: '插入图片',
			file : tinyMCE.baseURL + '/plugins/filemanager/myupload.html',
			// file : 'http://dev.cp.gaofen.com/static/js/tinymce/plugins/filemanager/myupload.html',
			width : 400,
			height: 210,
			buttons: [{
				text: 'Upload',
				classes:'widget btn primary first abs-layout-item',
				//disabled : true,
				onclick: myupload.upload
			},
			{
				text: 'Close',
				onclick: 'close'
			}]
		});
		//myupload.init();
		//editor.selection.setContent('<h3 class="secondary">二级栏目</h3>');
	}
	
	// Add a button that opens a window
	editor.addButton('myupload', {
		tooltip: '上传图片',
		icon : 'image',
		text: '',
		onclick: upload
	});

	// Adds a menu item to the tools menu
	editor.addMenuItem('myupload', {
		text: '上传图片',
		icon : 'image',
		context: 'insert',
		onclick: upload
	});

	//editor.selection.setContent('<h3 class="secondary">二级栏目</h3>');

	var myupload = {
		upload : function(){
			var uploadbody = parent.window.jQuery('body').find('iframe[src$="myupload.html"]');
			if(!uploadbody[0]){
				var li = parent.window.jQuery('body').find('#js_menu_contents li.focus');
				if(li.length){
					var key = li.index();
					var curIfr = parent.window.jQuery('body').find('#main_frame>iframe').eq(key);
					uploadbody = curIfr[0].contentWindow.window.$('body').find('iframe[src$="myupload.html"]');
					if(uploadbody && uploadbody[0]){
						var result = uploadbody[0].contentWindow.window.myupload.getInfo(myupload.insert, myupload.close);
					}else
						console.log('upload error!')
				}
			}else{//独立发布页面使用
				var result = uploadbody[0].contentWindow.window.myupload.getInfo(myupload.insert, myupload.close);
			}
		},
		insert : function(r){
			if(r === ''){
				myupload.close();
				return;
			}

			if(r.img){
				var width = Number(r.imgWidth)||'', height = Number(r.imgHeight)||'';
				if(width){
					width = 'width="'+width+'"';
				}
				if(height){
					height = 'height="'+height+'"';
				}
				var html = '<img src="'+r.img+'" '+width+' '+height+' alt="'+r.imgTitle+'" />';
				if(r.imgLink){
					html = '<a target="_blank" href="'+r.imgLink+'" title="'+r.imgTitle+'" class="img-link"><img src="'+r.img+'" '+width+' '+height+' alt="'+r.imgTitle+'" /></a>';
				}
				editor.execCommand('mceInsertContent',false, html);			
				// editor.selection.setContent('<img src="'+r.img+'" width="'+width+'" height="'+height+'" title="'+title+'" alt="'+title+'" />');			
			}

		},

		close : function(){
			tinymce.EditorManager.activeEditor.windowManager.close(window);
		}
	};
});