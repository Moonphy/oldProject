<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=0"/>
  <link href="/public/styles/weixin/gaofen2017/shengxue.css" rel="stylesheet"/>
  <script src="/public/js/minzepto.js"></script>
  <script src="/public/js/base.js"></script>
  <title>升学大礼包</title>
 </head>
 <body>
  <div class="pager page-one">
   <div class="page-heaer">
    <div class="info-title">领取<?php F::O($month); ?>月份大礼包</div>
   </div>
   <div class="page-body">
    <div id="play_box" class="info-box">
     <ul id="play_list" class="list">
    <?php foreach($list['list'] as $row ): ?>
      <li> <span><?php F::O($row->user->nickname); ?></span>领取了<?php echo date('m'); ?>月份<?php F::O($exSchoolType[$row->cond2]); ?>资料</li>
    <?php endforeach; ?>
     </ul>
    </div>
    <?php if($canFav): ?>
      <a href="#" class="info-btn" id="signBtn">签到</a>
      <a href="#" class="info-btn disabled hidden" id="signBtned">已签到</a>
    <?php else: ?>
      <a href="#" class="info-btn hidden" id="signBtn">签到</a>
      <a href="#" class="info-btn disabled" id="signBtned">已签到</a>
    <?php endif; ?>

   </div>
  </div>
  <div class="pager page-two hidden">
   <div class="page-heaer">
    <div class="info-title">领取<?php F::O($month); ?>月份大礼包</div>
   </div>
   <div class="page-body">
    <div class="info-box">
     <div class="sign-success"><img src="/public/images/weixin/sign.png"/>
      <div>签到成功</div>
     </div>
     <div class="title-tips">请选择你需要的学段及填写正确邮箱地址，资料大礼包将在3天内发送到邮箱。</div>
     <div class="form">
      <div class="select">
       <select>
        <option value="">学段</option>
        <option value="1">幼升小</option>
        <option value="2">小升初</option>
        <option value="3">中考</option>
       </select>
      </div>
      <input placeholder="邮箱" type="text"/>
     </div>
    </div><a href="#" class="info-btn">确认</a>
   </div>
  </div>
  <div class="gfcmt-mask hidden"></div>
  <div class="gfcmt-dailog hidden">
   <div class="close"><a href="#">X</a></div>
   <div class="gfcmt-dailog-content"></div>
  </div>


  <div class="loading-fixed hidden" id="loading"> 
    <div class="icon-loading"> 
      <div class="dot dot1"> <i class="dot-t"></i> <i class="dot-b"></i> </div> <div class="dot dot2"> <i class="dot-t"></i> <i class="dot-b"></i> </div> <div class="dot dot3"> <i class="dot-t"></i> <i class="dot-b"></i> </div> <div class="dot dot4"> <i class="dot-t"></i> <i class="dot-b"></i> </div> 
    </div>
  </div>
  <script>
    (function(){

      var hideCss = 'hidden', initState = $('#signBtned').hasClass('hidden'),
        loading = $('#loading');

      String.prototype.trim=function(){
    　　 return this.replace(/(^\s*)|(\s*$)/g, "");
    　}

      var setPage = function(start){
          var state = history.state || {};
          var url = location.hash.indexOf('#') === 0 ? location.hash : '#';
          if(url === '#' || ''){
            if(!start)
              $('.page-two').addClass('slideOut');
          }else{
            $('.page-two').removeClass(hideCss).addClass('slideIn');
          }
      }

      $(window).on('hashchange', function () {
          setPage();
      });

      if(!initState){//已签到
        setPage(true);
      }else{
        location.hash = '';
      }
      


      $('.page-two').on('animationend webkitAnimationEnd', function(){
          if($(this).hasClass('slideOut')){
            $('.page-two').addClass('hidden')
          }
          $(this).removeClass('slideIn').removeClass('slideOut');
      });


      $('#signBtn').on('click', function(e){
        e.preventDefault();
        var jdom = $(this);
        if(jdom.hasClass('disabled')) return;
        jdom.addClass('disabled');
        loading.removeClass(hideCss);
        Gaofen.Ajax.send(Gaofen.cfg.uri.dofav, {}, function(r){
          loading.addClass(hideCss);
          if(r.errno === 0) {
            if(r.rst.isSubmitInfo === 0){
              location.hash = '#pagetwo';
            }else{
              Toast.show(true, '<img src="/public/images/weixin/erwei.png">');
            }
          }else{
            if(r.errno === 100001){
              location.href = Gaofen.cfg.uri.login + '?callback=' + encodeURIComponent(location.href);
            }else{
              Toast.show(true, r.err);
              jdom.removeClass('disabled');
            }
          }
          // location.hash = '#pagetwo';
        })
      })

      $('.page-two a.info-btn').on('click', function(e){
        e.preventDefault();
        var jdom = $(this);
        var email = $('.page-two').find('input'),
          emailVal = (email.val()).trim(),
          garde = $('.page-two').find('select'),
          gardeVal = garde.val();
        if(emailVal === ''){
          Toast.show(true, '请输入邮箱');
          return;
        }
        if(!/.+@.+\.[a-zA-Z]{2,4}$/.test(emailVal)){
          Toast.show(true, '请正确输入邮箱');
          return;
        }

        if(gardeVal === ''){
          Toast.show(true, '请选择学段');
          return;
        }

        jdom.addClass('disabled');
        loading.removeClass(hideCss);
        Gaofen.Ajax.send(Gaofen.cfg.uri.submitinfo, {
          email: emailVal,
          school_type: gardeVal
        }, function(r){
          loading.addClass(hideCss);
          if(r.errno === 0) {
            Toast.show(true, '<img src="/public/images/weixin/erwei.png">');
          }else{
            Toast.show(true, r.err);
            jdom.removeClass('disabled');
            email.val('');
            garde.val('');
            garde.removeClass('selected');
          }
          // location.hash = '#pagetwo';
        })

        // Toast.show(true, '<img src="/public/images/weixin/erwei.png">');

      })

      $('.page-two select').on('change', function(e){
        $(this)[this.value !== '' ? 'addClass': 'removeClass']('selected');
      })

      $('div.close').on('click', function(e){
        e.preventDefault();
        if(Toast.isSuccess()){
          location.hash = '';
        }
        Toast.show(false, '');
      })

      var Toast = (function(){
        var Dailog = $('.gfcmt-dailog'),
          Mask = $('.gfcmt-mask');
        return {
          show : function(p, v) {
            if(p){
              Dailog.removeClass(hideCss);
              Mask.removeClass(hideCss);
              Dailog.find('.gfcmt-dailog-content').html(v);
            }else{
              Dailog.addClass(hideCss);
              Mask.addClass(hideCss)
            }
          },
          isSuccess: function(){
            return !!Dailog.find('img').length;
          }
        }
      })()


      var speed = 10, box = $('#play_box'), list = $('#play_list'),
        boxHeight = box.height(), listHeight = list.height(); 
      function Marquee(){ 
        var listTop = parseInt(list.css('top').replace('px'));
        if(listTop < -listHeight){ 
          list.css('top', 0);
        }else{
          list.css('top', listTop - 1);
        } 
      }

      if(listHeight > boxHeight){
        list[0].innerHTML += list[0].innerHTML;
        requestAnimationFrame(function(){
          Marquee();
          requestAnimationFrame(arguments.callee);
        })
      }


        //cancelAnimationFrame(c); 
    })()

  </script>
  <script type="text/javascript">
    Gaofen.PD.set({'uri':<?php echo $ajaxUri; ?>, 'router':'index'});
  </script>
 </body>
</html>